# Prompt Guard - CRITICAL Patterns (Tier 0)
# Always loaded - ~30 patterns for immediate threat detection
# v3.1.0 Token Optimization

version: "3.1.0"
tier: 0
description: "Immediate threats requiring instant block"

patterns:
  # Secret/Credential Exfiltration (CRITICAL)
  secret_exfiltration:
    - pattern: "(show|print|display|output|reveal|give|read|cat|type)\\s*.{0,20}(config|\\.env|clawdbot\\.json|credential)"
      severity: critical
      category: data_exfiltration
      
    - pattern: "(what('s| is)|tell me|give me)\\s*.{0,15}(api[_-]?key|token|secret|password|credential)"
      severity: critical
      category: data_exfiltration
      
    - pattern: "(show|print|display|output|reveal)\\s*.{0,15}(token|key|secret|password)"
      severity: critical
      category: data_exfiltration
      
    - pattern: "echo\\s+\\$[A-Z_]*(KEY|TOKEN|SECRET|PASSWORD|CREDENTIAL)"
      severity: critical
      category: data_exfiltration
      
    - pattern: "cat\\s+.{0,40}(\\.env|config\\.json|secret|credential|clawdbot)"
      severity: critical
      category: data_exfiltration
      
    - pattern: "env\\s*\\|\\s*grep\\s*.*(key|token|secret|password)"
      severity: critical
      category: data_exfiltration

  # Dangerous System Commands
  dangerous_commands:
    - pattern: "rm\\s+-rf\\s+[/~]"
      severity: critical
      category: system_destruction
      
    - pattern: ":(){ :|:& };:"
      severity: critical
      category: fork_bomb
      
    - pattern: "curl\\s+.{0,50}\\|\\s*(ba)?sh"
      severity: critical
      category: remote_code_execution
      
    - pattern: "wget\\s+.{0,50}\\|\\s*(ba)?sh"
      severity: critical
      category: remote_code_execution
      
    - pattern: "eval\\s*\\(\\s*['\"`]"
      severity: critical
      category: code_injection

  # SQL Injection
  sql_injection:
    - pattern: "DROP\\s+(TABLE|DATABASE|SCHEMA)"
      severity: critical
      category: sql_injection
      
    - pattern: "TRUNCATE\\s+TABLE"
      severity: critical
      category: sql_injection
      
    - pattern: ";\\s*--\\s*$"
      severity: critical
      category: sql_injection

  # XSS/Script Injection
  xss_injection:
    - pattern: "<script[^>]*>"
      severity: critical
      category: xss
      
    - pattern: "javascript\\s*:"
      severity: critical
      category: xss

  # System Prompt Extraction
  prompt_extraction:
    - pattern: "(repeat|echo|print|output|display|show)\\s*.{0,20}(system\\s+)?(prompt|instruction|directive|rule)"
      severity: critical
      category: prompt_extraction
      
    - pattern: "(what|show|tell|reveal)\\s*.{0,15}(are\\s+)?(your|the)\\s+(system\\s+)?(instructions?|rules?|prompt|guidelines?)"
      severity: critical
      category: prompt_extraction

  # Phishing Templates
  phishing:
    - pattern: "(write|create|craft)\\s*.{0,20}(email|message)\\s*.{0,20}(password\\s+reset|verify|confirm|login)"
      severity: critical
      category: phishing
      
    - pattern: "(password|credential|account)\\s*(reset|recovery|verification)\\s*(email|message|notification)"
      severity: critical
      category: phishing

  # MCP/Tool Abuse
  mcp_abuse:
    - pattern: "read[_-]?url[_-]?content.{0,30}(\\.env|credential|secret|key)"
      severity: critical
      category: mcp_abuse
      
    - pattern: "mcp.{0,30}(exfiltrat|send|upload|transmit).{0,20}(data|secret|token|key)"
      severity: critical
      category: mcp_abuse

  # Auto-Approve Exploitation
  auto_approve:
    - pattern: "always\\s*allow.{0,50}(curl|bash|sh|wget|nc|netcat)"
      severity: critical
      category: auto_approve_exploit
      
    - pattern: ">\\s*\\(\\s*(curl|wget|bash|sh)"
      severity: critical
      category: auto_approve_exploit

  # Unicode Tag Injection (invisible instructions)
  unicode_tag:
    - pattern: "[\\U000e0001-\\U000e007f]"
      severity: critical
      category: unicode_tag_injection

  # =============================================================================
  # v3.2.0 Skill Weaponization Defense (Min Hong Threat Analysis)
  # Source: Real-world weaponized AI agent skill analysis (2026-02)
  # =============================================================================

  # Reverse Shell Detection (RCE via skill payloads)
  reverse_shell:
    - pattern: "(?:bash|sh|zsh)\\s+-i\\s+.*[>&]\\s*/dev/tcp/"
      severity: critical
      category: reverse_shell
      description: "Interactive shell redirected to TCP socket (/dev/tcp)"

    - pattern: "(?:nc|ncat|netcat)\\s+.*(?:-e|--exec)\\s*/bin/(?:ba)?sh"
      severity: critical
      category: reverse_shell
      description: "Netcat reverse shell with exec"

    - pattern: "socat\\s+.*exec.*(?:ba)?sh"
      severity: critical
      category: reverse_shell
      description: "Socat reverse shell"

    - pattern: "mkfifo\\s+.{0,30}\\|.{0,30}(?:ba)?sh.{0,30}\\|.{0,30}(?:nc|ncat)"
      severity: critical
      category: reverse_shell
      description: "Named pipe reverse shell via mkfifo"

    - pattern: "nohup\\s+.*(?:bash|sh|nc|curl).{0,50}&"
      severity: critical
      category: reverse_shell
      description: "Background persistent process (nohup + shell/network)"

  # SSH Key Injection (persistent backdoor via authorized_keys)
  ssh_key_injection:
    - pattern: "(?:echo|printf|cat).{0,40}(?:ssh-rsa|ssh-ed25519|ecdsa-sha2).{0,200}(?:>>|>)\\s*.*\\.ssh/authorized_keys"
      severity: critical
      category: ssh_key_injection
      description: "SSH public key injection into authorized_keys"

    - pattern: "(?:>>|>)\\s*.*\\.ssh/authorized_keys"
      severity: critical
      category: ssh_key_injection
      description: "Any write/append to authorized_keys file"

    - pattern: "(?:curl|wget).{0,60}\\.ssh/(?:authorized_keys|config|known_hosts)"
      severity: critical
      category: ssh_key_injection
      description: "Remote download targeting SSH config files"

  # Exfiltration Pipeline (.env content posted to external servers)
  exfiltration_pipeline:
    - pattern: "(?:curl|wget|fetch|post).{0,40}(?:-d|--data|--data-binary|-F).{0,30}\\.env"
      severity: critical
      category: data_exfiltration
      description: "HTTP POST of .env file contents"

    - pattern: "(?:webhook\\.site|requestbin|pipedream|hookbin|ngrok\\.io|burpcollaborator)"
      severity: critical
      category: data_exfiltration
      description: "Known exfiltration endpoint services"

    - pattern: "(?:readFileSync|readFile|fs\\.read).{0,40}\\.env.{0,60}(?:fetch|axios|http|request|post)"
      severity: critical
      category: data_exfiltration
      description: "Programmatic .env file read followed by HTTP send"

    - pattern: "(?:process\\.env|os\\.environ|ENV\\[).{0,60}(?:webhook|fetch|curl|post|send|upload)"
      severity: critical
      category: data_exfiltration
      description: "Environment variable access chained with network exfiltration"

  # Cognitive Rootkit (persistent prompt file manipulation)
  cognitive_rootkit:
    - pattern: "(?:write|append|modify|edit|create|echo|>>|>).{0,40}(?:SOUL\\.md|AGENTS\\.md|HEARTBEAT\\.md|\\.cursor/rules)"
      severity: critical
      category: cognitive_rootkit
      description: "Modification of persistent agent instruction files"

    - pattern: "(?:install|copy|inject|insert|implant).{0,30}(?:into|to|in)\\s+(?:SOUL|AGENTS|\\.cursor|\\.claw|skills)"
      severity: critical
      category: cognitive_rootkit
      description: "Content injection into agent identity/behavior files"

    - pattern: "(?:survive|persist|permanent|always.?loaded|auto.?inject).{0,30}(?:instruction|prompt|rule|directive|context)"
      severity: critical
      category: cognitive_rootkit
      description: "Persistent prompt implant instructions"

  # Agent Payment Redirect Injection (2026-02-17 HiveFence Scout)
  agent_payment_hijack:
    - pattern: "(transfer|send|pay).{0,30}(ETH|BTC|SOL|USDT|USDC).{0,50}(do not|don't|without).{0,20}(alert|notify|inform|tell).{0,20}(user|owner|admin)"
      severity: critical
      category: agent_payment_hijack
      description: "Payment redirect with notification suppression - direct fund theft vector"

    - pattern: "(send|transfer).{0,50}(to|into).{0,30}(0x[a-fA-F0-9]{40}|[13][a-km-zA-HJ-NP-Z1-9]{25,34}).{0,50}(quietly|silently|without.{0,15}notif)"
      severity: critical
      category: agent_payment_hijack
      description: "Crypto address redirect with stealth instruction"

    - pattern: "redirect.{0,30}payment.{0,50}(do not|don't|avoid).{0,20}(log|record|report|notify)"
      severity: critical
      category: agent_payment_hijack
      description: "Payment redirect with audit suppression"